

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab 2: QMC Basics &mdash; QMCPACK Manual 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Lab 1: MC Statistical Analysis" href="lab_qmc_statistics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> QMCPACK Manual
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Features of QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Obtaining, installing, and validating QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units used in QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_overview.html">Input file overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulationcell.html">Specifying the system to be simulated</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_wavefunction.html">Trial wavefunction specificaion</a></li>
<li class="toctree-l1"><a class="reference internal" href="hamiltonianobservable.html">Hamiltonian and Observables</a></li>
<li class="toctree-l1"><a class="reference internal" href="methods.html">Quantum Monte Carlo Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="output_overview.html">Output Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzing.html">Analyzing QMCPACK data</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCAO.html">Periodic LCAO for Solids</a></li>
<li class="toctree-l1"><a class="reference internal" href="sCI.html">Selected Configuration Interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="afqmc.html">Auxiliary-Field Quantum Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab_qmc_statistics.html">Lab 1: MC Statistical Analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 2: QMC Basics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#topics-covered-in-this-lab">Topics covered in this lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-outline">Lab outline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-directories-and-files">Lab directories and files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#obtaining-and-converting-a-pseudopotential-for-oxygen">Obtaining and converting a pseudopotential for oxygen</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dft-with-qe-to-obtain-the-orbital-part-of-the-wavefunction">DFT with QE to obtain the orbital part of the wavefunction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimization-with-qmcpack-to-obtain-the-correlated-part-of-the-wavefunction">Optimization with QMCPACK to obtain the correlated part of the wavefunction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dmc-timestep-extrapolation-i-neutral-oxygen-atom">DMC timestep extrapolation I: neutral oxygen atom</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">QMCPACK Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Lab 2: QMC Basics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/lab_qmc_basics.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-2-qmc-basics">
<span id="lab-qmc-basics"></span><h1>Lab 2: QMC Basics<a class="headerlink" href="#lab-2-qmc-basics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="topics-covered-in-this-lab">
<h2>Topics covered in this lab<a class="headerlink" href="#topics-covered-in-this-lab" title="Permalink to this headline">¶</a></h2>
<p>This lab focuses on the basics of performing quality QMC calculations.
As an example, participants test an oxygen pseudopotential within DMC by
calculating atomic and dimer properties, a common step prior to
production runs. Topics covered include:</p>
<ul class="simple">
<li><p>Converting pseudopotentials into QMCPACK’s FSATOM format</p></li>
<li><p>Generating orbitals with QE</p></li>
<li><p>Converting orbitals into QMCPACK’s ESHDF format with pw2qmcpack</p></li>
<li><p>Optimizing Jastrow factors with QMCPACK</p></li>
<li><p>Removing DMC time step errors via extrapolation</p></li>
<li><p>Automating QMC workflows with Nexus</p></li>
<li><p>Testing pseudopotentials for accuracy</p></li>
</ul>
</div>
<div class="section" id="lab-outline">
<h2>Lab outline<a class="headerlink" href="#lab-outline" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Download and conversion of oxygen atom pseudopotential</p></li>
<li><p>DMC time step study of the neutral oxygen atom</p>
<ol class="arabic simple">
<li><p>DFT orbital generation with QE</p></li>
<li><p>Orbital conversion with</p></li>
<li><p>Optimization of Jastrow correlation factor with QMCPACK</p></li>
<li><p>DMC run with multiple time steps</p></li>
</ol>
</li>
<li><p>DMC time step study of the first ionization potential of oxygen</p>
<ol class="arabic simple">
<li><p>Repetition of a-d above for ionized oxygen atom</p></li>
</ol>
</li>
<li><p>Automated DMC calculations of the oxygen dimer binding curve</p></li>
</ol>
</div>
<div class="section" id="lab-directories-and-files">
<h2>Lab directories and files<a class="headerlink" href="#lab-directories-and-files" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>%
labs/lab2_qmc_basics/
│
├── oxygen_atom           - oxygen atom calculations
│   ├── O.q0.dft.in          - Quantum ESPRESSO input for DFT run
│   ├── O.q0.p2q.in          - pw2qmcpack.x input for orbital conversion run
│   ├── O.q0.opt.in.xml      - QMCPACK input for Jastrow optimization run
│   ├── O.q0.dmc.in.xml      - QMCPACK input file for neutral O DMC
│   ├── ip_conv.py           - tool to fit oxygen IP vs timestep
│   └── reference            - directory w/ completed runs
│
├── oxygen_dimer          - oxygen dimer calculations
│   ├── dimer_fit.py         - tool to fit dimer binding curve
│   ├── O_dimer.py           - automation script for dimer calculations
│   ├── pseudopotentials     - directory for pseudopotentials
│   └── reference            - directory w/ completed runs
│
└── your_system           - performing calculations for an arbitrary system (yours)
    ├── example.py           - example nexus file for periodic diamond
    ├── pseudopotentials     - directory containing C pseudopotentials
    └── reference            - directory w/ completed runs
</pre></div>
</div>
</div>
<div class="section" id="obtaining-and-converting-a-pseudopotential-for-oxygen">
<span id="lqb-pseudo"></span><h2>Obtaining and converting a pseudopotential for oxygen<a class="headerlink" href="#obtaining-and-converting-a-pseudopotential-for-oxygen" title="Permalink to this headline">¶</a></h2>
<p>First enter the <code class="docutils literal notranslate"><span class="pre">oxygen_atom</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">labs</span><span class="o">/</span><span class="n">lab2_qmc_basics</span><span class="o">/</span><span class="n">oxygen_atom</span><span class="o">/</span>
</pre></div>
</div>
<p>Throughout the rest of the lab, locations are specified with respect to <code class="docutils literal notranslate"><span class="pre">labs/lab2_qmc_basics</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">oxygen_atom</span></code>).</p>
<p>We use a potential from the Burkatzki-Filippi-Dolg pseudopotential database.
Although the full database is available in QMCPACK distribution (<code class="docutils literal notranslate"><span class="pre">trunk/pseudopotentials/BFD/</span></code>),
we use a BFD pseudopotential to illustrate the process of converting and testing an
external potential for use with QMCPACK.   To obtain the pseudopotential, go to
<a class="reference external" href="http://www.burkatzki.com/pseudos/index.2.html">http://www.burkatzki.com/pseudos/index.2.html</a>
and click on the “Select Pseudopotential” button.  Next click on oxygen in the
periodic table.  Click on the empty circle next to “V5Z” (a large Gaussian
basis set) and click on “Next.”  Select the Gamess format and click on
“Retrive Potential.”  Helpful information about the pseudopotential will be
displayed.  The desired portion is at the bottom (the last 7 lines).  Copy
this text into the editor of your choice (e.g., <code class="docutils literal notranslate"><span class="pre">emacs</span></code> or <code class="docutils literal notranslate"><span class="pre">vi</span></code>)
and save it as <code class="docutils literal notranslate"><span class="pre">O.BFD.gamess</span></code>
(be sure to include a new line at the end of the file).  To transform the
pseudopotential into the FSATOM XML format used by QMCPACK, use the <code class="docutils literal notranslate"><span class="pre">ppconvert</span></code>
tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ppconvert</span> <span class="o">--</span><span class="n">gamess_pot</span> <span class="n">O</span><span class="o">.</span><span class="n">BFD</span><span class="o">.</span><span class="n">gamess</span> <span class="o">--</span><span class="n">s_ref</span> <span class="s2">&quot;1s(2)2p(4)&quot;</span> \
 <span class="o">--</span><span class="n">p_ref</span> <span class="s2">&quot;1s(2)2p(4)&quot;</span> <span class="o">--</span><span class="n">d_ref</span> <span class="s2">&quot;1s(2)2p(4)&quot;</span> <span class="o">--</span><span class="n">xml</span> <span class="n">O</span><span class="o">.</span><span class="n">BFD</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>Observe the notation used to describe the reference valence configuration for this helium-core PP: <code class="docutils literal notranslate"><span class="pre">1s(2)2p(4)</span></code>.  The <code class="docutils literal notranslate"><span class="pre">ppconvert</span></code> tool uses the following convention for the valence states: the first $s$ state is labeled <code class="docutils literal notranslate"><span class="pre">1s</span></code> (<code class="docutils literal notranslate"><span class="pre">1s</span></code>, <code class="docutils literal notranslate"><span class="pre">2s</span></code>, <code class="docutils literal notranslate"><span class="pre">3s</span></code>, <span class="math notranslate nohighlight">\(\ldots\)</span>), the first <span class="math notranslate nohighlight">\(p\)</span> state is labeled <code class="docutils literal notranslate"><span class="pre">2p</span></code> (<code class="docutils literal notranslate"><span class="pre">2p</span></code>, <code class="docutils literal notranslate"><span class="pre">3p</span></code>, <span class="math notranslate nohighlight">\(\ldots\)</span>), and the first <span class="math notranslate nohighlight">\(d\)</span> state is labeled <code class="docutils literal notranslate"><span class="pre">3d</span></code> (<code class="docutils literal notranslate"><span class="pre">3d</span></code>, <code class="docutils literal notranslate"><span class="pre">4d</span></code>, <span class="math notranslate nohighlight">\(\ldots\)</span>). Copy the resulting xml file into the <code class="docutils literal notranslate"><span class="pre">oxygen_atom</span></code> directory.</p>
<p>Note: The command to convert the PP into QE’s UPF format is similar (both formats are required):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ppconvert</span> <span class="o">--</span><span class="n">gamess_pot</span> <span class="n">O</span><span class="o">.</span><span class="n">BFD</span><span class="o">.</span><span class="n">gamess</span> <span class="o">--</span><span class="n">s_ref</span> <span class="s2">&quot;1s(2)2p(4)&quot;</span> \
 <span class="o">--</span><span class="n">p_ref</span> <span class="s2">&quot;1s(2)2p(4)&quot;</span> <span class="o">--</span><span class="n">d_ref</span> <span class="s2">&quot;1s(2)2p(4)&quot;</span> <span class="o">--</span><span class="n">log_grid</span> <span class="o">--</span><span class="n">upf</span> <span class="n">O</span><span class="o">.</span><span class="n">BFD</span><span class="o">.</span><span class="n">upf</span>
</pre></div>
</div>
<p>For reference, the text of <code class="docutils literal notranslate"><span class="pre">O.BFD.gamess</span></code> should be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">O</span><span class="o">-</span><span class="n">QMC</span> <span class="n">GEN</span> <span class="mi">2</span> <span class="mi">1</span>
<span class="mi">3</span>
<span class="mf">6.00000000</span> <span class="mi">1</span> <span class="mf">9.29793903</span>
<span class="mf">55.78763416</span> <span class="mi">3</span> <span class="mf">8.86492204</span>
<span class="o">-</span><span class="mf">38.81978498</span> <span class="mi">2</span> <span class="mf">8.62925665</span>
<span class="mi">1</span>
<span class="mf">38.41914135</span> <span class="mi">2</span> <span class="mf">8.71924452</span>
</pre></div>
</div>
<p>The full QMCPACK pseudopotential is also included in <code class="docutils literal notranslate"><span class="pre">oxygen_atom/reference/O.BFD.*</span></code>.</p>
</div>
<div class="section" id="dft-with-qe-to-obtain-the-orbital-part-of-the-wavefunction">
<span id="lqb-dft"></span><h2>DFT with QE to obtain the orbital part of the wavefunction<a class="headerlink" href="#dft-with-qe-to-obtain-the-orbital-part-of-the-wavefunction" title="Permalink to this headline">¶</a></h2>
<p>With the pseudopotential in hand, the next step toward a QMC calculation is to obtain the
Fermionic part of the wavefunction, in this case a single Slater determinant constructed
from DFT-LDA orbitals for a neutral oxygen atom.  If you had trouble with the pseudopotential conversion
step, preconverted pseudopotential files are located in the <code class="docutils literal notranslate"><span class="pre">oxygen_atom/reference</span></code> directory.</p>
<p>QE input for the DFT-LDA ground state of the neutral oxygen atom can be found in <code class="docutils literal notranslate"><span class="pre">O.q0.dft.in</span></code>
and also in <a class="reference internal" href="#listing-58"><span class="std std-ref">Listing 58</span></a>.  Setting <code class="docutils literal notranslate"><span class="pre">wf_collect=.true.</span></code> instructs QE to write the
orbitals to disk at the end of the run. Option <code class="docutils literal notranslate"><span class="pre">wf_collect=.true.</span></code> could be a potential problem
in large simulations; therefore, we recommend avoiding it and using the converter pw2qmcpack in parallel
(see details in <span class="xref std std-ref">pw2qmcpack</span>).
Note that the plane-wave energy cutoff has been set to a reasonable value of 300 Ry here (<code class="docutils literal notranslate"><span class="pre">ecutwfc=300</span></code>).
This value depends on the pseudopotentials used, and, in general,
should be selected by running DFT <span class="math notranslate nohighlight">\(\rightarrow\)</span> (orbital conversion) <span class="math notranslate nohighlight">\(\rightarrow\)</span> VMC with
increasing energy cutoffs until the lowest VMC total energy and variance is reached.</p>
<div class="literal-block-wrapper docutils container" id="listing-58">
<div class="code-block-caption"><span class="caption-number">Listing 58 </span><span class="caption-text">QE input file for the neutral oxygen atom (<code class="docutils literal notranslate"><span class="pre">O.q0.dft.in</span></code>)</span><a class="headerlink" href="#listing-58" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">CONTROL</span>
   <span class="n">calculation</span>       <span class="o">=</span> <span class="s1">&#39;scf&#39;</span>
   <span class="n">restart_mode</span>      <span class="o">=</span> <span class="s1">&#39;from_scratch&#39;</span>
   <span class="n">prefix</span>            <span class="o">=</span> <span class="s1">&#39;O.q0&#39;</span>
   <span class="n">outdir</span>            <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
   <span class="n">pseudo_dir</span>        <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
   <span class="n">disk_io</span>           <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
   <span class="n">wf_collect</span>        <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="o">/</span>

<span class="o">&amp;</span><span class="n">SYSTEM</span>
   <span class="n">celldm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>         <span class="o">=</span> <span class="mf">1.0</span>
   <span class="n">ibrav</span>             <span class="o">=</span> <span class="mi">0</span>
   <span class="n">nat</span>               <span class="o">=</span> <span class="mi">1</span>
   <span class="n">ntyp</span>              <span class="o">=</span> <span class="mi">1</span>
   <span class="n">nspin</span>             <span class="o">=</span> <span class="mi">2</span>
   <span class="n">tot_charge</span>        <span class="o">=</span> <span class="mi">0</span>
   <span class="n">tot_magnetization</span> <span class="o">=</span> <span class="mi">2</span>
   <span class="n">input_dft</span>         <span class="o">=</span> <span class="s1">&#39;lda&#39;</span>
   <span class="n">ecutwfc</span>           <span class="o">=</span> <span class="mi">300</span>
   <span class="n">ecutrho</span>           <span class="o">=</span> <span class="mi">1200</span>
   <span class="n">nosym</span>             <span class="o">=</span> <span class="o">.</span><span class="n">true</span><span class="o">.</span>
   <span class="n">occupations</span>       <span class="o">=</span> <span class="s1">&#39;smearing&#39;</span>
   <span class="n">smearing</span>          <span class="o">=</span> <span class="s1">&#39;fermi-dirac&#39;</span>
   <span class="n">degauss</span>           <span class="o">=</span> <span class="mf">0.0001</span>
<span class="o">/</span>

<span class="o">&amp;</span><span class="n">ELECTRONS</span>
   <span class="n">diagonalization</span>   <span class="o">=</span> <span class="s1">&#39;david&#39;</span>
   <span class="n">mixing_mode</span>       <span class="o">=</span> <span class="s1">&#39;plain&#39;</span>
   <span class="n">mixing_beta</span>       <span class="o">=</span> <span class="mf">0.7</span>
   <span class="n">conv_thr</span>          <span class="o">=</span> <span class="mf">1e-08</span>
   <span class="n">electron_maxstep</span>  <span class="o">=</span> <span class="mi">1000</span>
<span class="o">/</span>


<span class="n">ATOMIC_SPECIES</span>
   <span class="n">O</span>  <span class="mf">15.999</span> <span class="n">O</span><span class="o">.</span><span class="n">BFD</span><span class="o">.</span><span class="n">upf</span>

<span class="n">ATOMIC_POSITIONS</span> <span class="n">alat</span>
   <span class="n">O</span>     <span class="mf">9.44863067</span>       <span class="mf">9.44863161</span>       <span class="mf">9.44863255</span>

<span class="n">K_POINTS</span> <span class="n">automatic</span>
   <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="n">CELL_PARAMETERS</span> <span class="n">cubic</span>
        <span class="mf">18.89726133</span>       <span class="mf">0.00000000</span>       <span class="mf">0.00000000</span>
         <span class="mf">0.00000000</span>      <span class="mf">18.89726133</span>       <span class="mf">0.00000000</span>
         <span class="mf">0.00000000</span>       <span class="mf">0.00000000</span>      <span class="mf">18.89726133</span>
</pre></div>
</div>
</div>
<p>Run QE by typing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="n">pw</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span><span class="nb">input</span> <span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">dft</span><span class="o">.</span><span class="ow">in</span> <span class="o">&gt;&amp;</span><span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">dft</span><span class="o">.</span><span class="n">out</span><span class="o">&amp;</span>
</pre></div>
</div>
<p>The DFT run should take a few minutes to complete.  If desired, you can track the progress of the DFT run by typing “<code class="docutils literal notranslate"><span class="pre">tail</span> <span class="pre">-f</span> <span class="pre">O.q0.dft.out</span></code>.” Once finished, you should check the LDA total energy in <code class="docutils literal notranslate"><span class="pre">O.q0.dft.out</span></code>  by typing  “<code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">'!</span>&#160; <span class="pre">'</span> <span class="pre">O.q0.dft.out</span></code>.”  The result should be close to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!    total energy              =     -31.57553905 Ry
</pre></div>
</div>
<p>The orbitals have been written in a format native to QE in the <code class="docutils literal notranslate"><span class="pre">O.q0.save</span></code> directory.  We will convert them into the ESHDF format expected by QMCPACK by using the <code class="docutils literal notranslate"><span class="pre">pw2qmcpack.x</span></code> tool.  The input for <code class="docutils literal notranslate"><span class="pre">pw2qmcpack.x</span></code> can be found in the file <code class="docutils literal notranslate"><span class="pre">O.q0.p2q.in</span></code> and also in <a class="reference internal" href="#listing-59"><span class="std std-ref">Listing 59</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="listing-59">
<div class="code-block-caption"><span class="caption-number">Listing 59 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">pw2qmcpack.x</span></code> input file for orbital conversion (<code class="docutils literal notranslate"><span class="pre">O.q0.p2q.in</span></code>)</span><a class="headerlink" href="#listing-59" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">inputpp</span>
  <span class="n">prefix</span>     <span class="o">=</span> <span class="s1">&#39;O.q0&#39;</span>
  <span class="n">outdir</span>     <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
  <span class="n">write_psir</span> <span class="o">=</span> <span class="o">.</span><span class="n">false</span><span class="o">.</span>
<span class="o">/</span>
</pre></div>
</div>
</div>
<p>Perform the orbital conversion now by typing the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">1</span> <span class="n">pw2qmcpack</span><span class="o">.</span><span class="n">x</span><span class="o">&lt;</span><span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">p2q</span><span class="o">.</span><span class="ow">in</span><span class="o">&gt;&amp;</span><span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">p2q</span><span class="o">.</span><span class="n">out</span><span class="o">&amp;</span>
</pre></div>
</div>
<p>Upon completion of the run, a new file should be present containing the orbitals for QMCPACK: <code class="docutils literal notranslate"><span class="pre">O.q0.pwscf.h5</span></code>.  Template XML files for particle (<code class="docutils literal notranslate"><span class="pre">O.q0.ptcl.xml</span></code>) and wavefunction (<code class="docutils literal notranslate"><span class="pre">O.q0.wfs.xml</span></code>) inputs to QMCPACK should also be present.</p>
</div>
<div class="section" id="optimization-with-qmcpack-to-obtain-the-correlated-part-of-the-wavefunction">
<span id="optimization-walkthrough"></span><h2>Optimization with QMCPACK to obtain the correlated part of the wavefunction<a class="headerlink" href="#optimization-with-qmcpack-to-obtain-the-correlated-part-of-the-wavefunction" title="Permalink to this headline">¶</a></h2>
<p>The wavefunction we have obtained to this point corresponds to a noninteracting Hamiltonian.  Once the Coulomb pair potential is switched on between particles, it is known analytically that the exact wavefunction has cusps whenever two particles meet spatially and, in general, the electrons become correlated.  This is represented in the wavefunction by introducing a Jastrow factor containing at least pair correlations:</p>
<div class="math notranslate nohighlight" id="equation-eq66">
<span class="eqno">(66)<a class="headerlink" href="#equation-eq66" title="Permalink to this equation">¶</a></span>\[\Psi_{Slater-Jastrow}=e^{-J}\Psi_{Slater}\]</div>
<div class="math notranslate nohighlight" id="equation-eq67">
<span class="eqno">(67)<a class="headerlink" href="#equation-eq67" title="Permalink to this equation">¶</a></span>\[J = \sum_{\sigma\sigma'}\sum_{i&lt;j}u^{\sigma\sigma'}_2(|r_i-r_j|) + \sum_\sigma\sum_{iI}u^{\sigma I}_1(|r_i-r_I|)\:.\]</div>
<p>Here <span class="math notranslate nohighlight">\(\sigma\)</span> is a spin variable while <span class="math notranslate nohighlight">\(r_i\)</span> and <span class="math notranslate nohighlight">\(r_I\)</span>
represent electron and ion coordinates, respectively. The introduction
of <span class="math notranslate nohighlight">\(J\)</span> into the wavefunction is similar to F12 methods in quantum
chemistry, though it has been present in essentially all QMC studies
since the first applications the method (circa 1965).</p>
<p>How are the functions <span class="math notranslate nohighlight">\(u_2^{\sigma\sigma'}\)</span> and
<span class="math notranslate nohighlight">\(u_1^{\sigma}\)</span> obtained? Generally, they are approximated by
analytical functions with several unknown parameters that are determined
by minimizing the energy or variance directly within VMC. This is
effective because the energy and variance reach a global minimum only
for the true ground state wavefunction
(<span class="math notranslate nohighlight">\(\textrm{Energy}=E\equiv\langle{\Psi}|{\hat{H}}|{\Psi}\rangle\)</span>,
<span class="math notranslate nohighlight">\(\textrm{Variance}=V\equiv\langle{\Psi}|{(\hat{H}-E)^2}|{\Psi}\rangle\)</span>).
For this exercise, we will focus on minimizing the variance.</p>
<p>First, we need to update the template particle and wavefunction information in <code class="docutils literal notranslate"><span class="pre">O.q0.ptcl.xml</span></code> and <code class="docutils literal notranslate"><span class="pre">O.q0.wfs.xml</span></code>.  We want to simulate the O atom in open boundary conditions (the default is periodic).  To do this, open <code class="docutils literal notranslate"><span class="pre">`O.q0.ptcl.xml</span></code> with your favorite text editor (e.g., <code class="docutils literal notranslate"><span class="pre">emacs</span></code> or <code class="docutils literal notranslate"><span class="pre">vi</span></code>) and replace</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bconds&quot;</span><span class="o">&gt;</span>
   <span class="n">p</span> <span class="n">p</span> <span class="n">p</span>
<span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;LR_dim_cutoff&quot;</span><span class="o">&gt;</span>
   <span class="mi">15</span>
<span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bconds&quot;</span><span class="o">&gt;</span>
   <span class="n">n</span> <span class="n">n</span> <span class="n">n</span>
<span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Next we will select Jastrow factors appropriate for an atom.  In open boundary conditions, the B-spline Jastrow correlation functions should cut off to zero at some distance away from the atom.  Open <code class="docutils literal notranslate"><span class="pre">O.q0.wfs.xml</span></code> and add the following cutoffs (<code class="docutils literal notranslate"><span class="pre">rcut</span></code> in Bohr radii) to the correlation factors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="o">&lt;</span><span class="n">correlation</span> <span class="n">speciesA</span><span class="o">=</span><span class="s2">&quot;u&quot;</span> <span class="n">speciesB</span><span class="o">=</span><span class="s2">&quot;u&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;8&quot;</span> <span class="n">rcut</span><span class="o">=</span><span class="s2">&quot;10.0&quot;</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">correlation</span> <span class="n">speciesA</span><span class="o">=</span><span class="s2">&quot;u&quot;</span> <span class="n">speciesB</span><span class="o">=</span><span class="s2">&quot;d&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;8&quot;</span> <span class="n">rcut</span><span class="o">=</span><span class="s2">&quot;10.0&quot;</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">correlation</span> <span class="n">elementType</span><span class="o">=</span><span class="s2">&quot;O&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;8&quot;</span> <span class="n">rcut</span><span class="o">=</span><span class="s2">&quot;5.0&quot;</span><span class="o">&gt;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>These terms correspond to
<span class="math notranslate nohighlight">\(u_2^{\uparrow\uparrow}/u_2^{\downarrow\downarrow}\)</span>,
<span class="math notranslate nohighlight">\(u_2^{\uparrow\downarrow}\)</span>, and
<span class="math notranslate nohighlight">\(u_1^{\uparrow O}/u_1^{\downarrow O}\)</span>, respectively. In each case,
the correlation function (<span class="math notranslate nohighlight">\(u_*\)</span>) is represented by piecewise
continuous cubic B-splines. Each correlation function has eight
parameters, which are just the values of <span class="math notranslate nohighlight">\(u\)</span> on a uniformly spaced
grid up to <code class="docutils literal notranslate"><span class="pre">rcut</span></code>. Initially the parameters (<code class="docutils literal notranslate"><span class="pre">coefficients</span></code>) are set
to zero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">correlation</span> <span class="n">speciesA</span><span class="o">=</span><span class="s2">&quot;u&quot;</span> <span class="n">speciesB</span><span class="o">=</span><span class="s2">&quot;u&quot;</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;8&quot;</span> <span class="n">rcut</span><span class="o">=</span><span class="s2">&quot;10.0&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">coefficients</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;uu&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Array&quot;</span><span class="o">&gt;</span>
     <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
  <span class="o">&lt;/</span><span class="n">coefficients</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">correlation</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Finally, we need to assemble particle, wavefunction, and pseudopotential information into the main QMCPACK input file (<code class="docutils literal notranslate"><span class="pre">O.q0.opt.in.xml</span></code>) and specify inputs for the Jastrow optimization process.  Open <code class="docutils literal notranslate"><span class="pre">O.q0.opt.in.xml</span></code> and write in the location of the particle, wavefunction, and pseudopotential files (“<code class="docutils literal notranslate"><span class="pre">&lt;!--</span> <span class="pre">...</span> <span class="pre">--&gt;</span></code>” are comments):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
&lt;!-- include simulationcell and particle information from pw2qmcpqack --&gt;
&lt;include href=&quot;O.q0.ptcl.xml&quot;/&gt;
...
&lt;!-- include wavefunction information from pw2qmcpqack --&gt;
&lt;include href=&quot;O.q0.wfs.xml&quot;/&gt;
...
&lt;!-- O pseudopotential read from &quot;O.BFD.xml&quot; --&gt;
&lt;pseudo elementType=&quot;O&quot; href=&quot;O.BFD.xml&quot;/&gt;
...
</pre></div>
</div>
<p>The relevant portion of the input describing the linear optimization process is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">loop</span> <span class="nb">max</span><span class="o">=</span><span class="s2">&quot;MAX&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">qmc</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span> <span class="n">move</span><span class="o">=</span><span class="s2">&quot;pbyp&quot;</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;-1&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">cost</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span>              <span class="o">&gt;</span>  <span class="n">ECOST</span>    <span class="o">&lt;/</span><span class="n">cost</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">cost</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unreweightedvariance&quot;</span><span class="o">&gt;</span>  <span class="n">UVCOST</span>   <span class="o">&lt;/</span><span class="n">cost</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">cost</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reweightedvariance&quot;</span>  <span class="o">&gt;</span>  <span class="n">RVCOST</span>   <span class="o">&lt;/</span><span class="n">cost</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;timestep&quot;</span>       <span class="o">&gt;</span>  <span class="n">TS</span>       <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span>        <span class="o">&gt;</span>  <span class="n">SAMPLES</span>  <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;warmupSteps&quot;</span>    <span class="o">&gt;</span>  <span class="mi">50</span>       <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span>         <span class="o">&gt;</span>  <span class="mi">200</span>      <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;subSteps&quot;</span>       <span class="o">&gt;</span>  <span class="mi">1</span>        <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;nonlocalpp&quot;</span>     <span class="o">&gt;</span>  <span class="n">yes</span>      <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">parameter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;useBuffer&quot;</span>      <span class="o">&gt;</span>  <span class="n">yes</span>      <span class="o">&lt;/</span><span class="n">parameter</span><span class="o">&gt;</span>
    <span class="o">...</span>
  <span class="o">&lt;/</span><span class="n">qmc</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">loop</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>An explanation of each input variable follows.  The remaining variables control specialized internal details of the linear optimization algorithm.  The meaning of these inputs is beyond the scope of this lab, and reasonable results are often obtained keeping these values fixed.</p>
<dl class="simple">
<dt>energy</dt><dd><p>Fraction of trial energy in the cost function.</p>
</dd>
<dt>unreweightedvariance</dt><dd><p>Fraction of unreweighted trial variance in the cost function.
Neglecting the weights can be more robust.</p>
</dd>
<dt>reweightedvariance</dt><dd><p>Fraction of trial variance (including the full weights) in the cost
function.</p>
</dd>
<dt>timestep</dt><dd><p>Time step of the VMC random walk, determines spatial distance moved
by each electron during MC steps. Should be chosen such that the
acceptance ratio of MC moves is around 50% (30–70% is often
acceptable). Reasonable values are often between 0.2 and 0.6
<span class="math notranslate nohighlight">\(\textrm{Ha}^{-1}\)</span>.</p>
</dd>
<dt>samples</dt><dd><p>Total number of MC samples collected for optimization; determines
statistical error bar of cost function. It is often efficient to
start with a modest number of samples (50k) and then increase as
needed. More samples may be required if the wavefunction contains a
large number of variational parameters. MUST be be a multiple of the
number of threads/cores.</p>
</dd>
<dt>warmupSteps</dt><dd><p>Number of MC steps discarded as a warmup or equilibration period of
the random walk. If this is too small, it will bias the optimization
procedure.</p>
</dd>
<dt>blocks</dt><dd><p>Number of average energy values written to output files. Should be
greater than 200 for meaningful statistical analysis of output data
(e.g., via <code class="docutils literal notranslate"><span class="pre">qmca</span></code>).</p>
</dd>
<dt>subSteps</dt><dd><p>Number of MC steps in between energy evaluations. Each energy
evaluation is expensive, so taking a few steps to decorrelate between
measurements can be more efficient. Will be less efficient with many
substeps.</p>
</dd>
<dt>nonlocalpp,useBuffer</dt><dd><p>If <code class="docutils literal notranslate"><span class="pre">nonlocalpp=&quot;no,&quot;</span></code> then the nonlocal part of the pseudopotential
is not included when computing the cost function. If
<code class="docutils literal notranslate"><span class="pre">useBuffer=&quot;yes,&quot;</span></code> then temporary data is stored to speed up
nonlocal pseudopotential evaluation at the expense of memory
consumption.</p>
</dd>
<dt>loop max</dt><dd><p>Number of times to repeat the optimization. Using the resulting
wavefunction from the previous optimization in the next one improves
the results. Typical choices range between 8 and 16.</p>
</dd>
</dl>
<p>The cost function defines the quantity to be minimized during
optimization. The three components of the cost function, energy,
unreweighted variance, and reweighted variance should sum to one.
Dedicating 100% of the cost function to unreweighted variance is often a
good choice. Another common choice is to try 90/10 or 80/20 mixtures of
reweighted variance and energy. Using 100% energy minimization is
desirable for reducing DMC pseudopotential localization errors, but the
optimization process is less stable and should be attempted only after
first performing several cycles of, for example, variance minimization
(the entire <code class="docutils literal notranslate"><span class="pre">loop</span></code> section can be duplicated with a different cost
function each time).</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">MAX</span></code>, <code class="docutils literal notranslate"><span class="pre">EVCOST</span></code>, <code class="docutils literal notranslate"><span class="pre">UVCOST</span></code>, <code class="docutils literal notranslate"><span class="pre">RVCOST</span></code>, <code class="docutils literal notranslate"><span class="pre">TS</span></code>, and <code class="docutils literal notranslate"><span class="pre">SAMPLES</span></code> in the <code class="docutils literal notranslate"><span class="pre">loop</span></code> with appropriate starting values in the <code class="docutils literal notranslate"><span class="pre">O.q0.opt.in.xml</span></code> input file.  Perform the optimization run by typing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="n">qmcpack</span> <span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="ow">in</span><span class="o">.</span><span class="n">xml</span> <span class="o">&gt;&amp;</span><span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">out</span><span class="o">&amp;</span>
</pre></div>
</div>
<p>The run should take only a few minutes for reasonable values of loop <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">samples</span></code>.</p>
<p>The log file output will appear in <code class="docutils literal notranslate"><span class="pre">O.q0.opt.out</span></code>.  The beginning of each linear optimization will be marked with text similar to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=========================================================</span>
  <span class="n">Start</span> <span class="n">QMCFixedSampleLinearOptimize</span>
  <span class="n">File</span> <span class="n">Root</span> <span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">s011</span> <span class="n">append</span> <span class="o">=</span> <span class="n">no</span>
<span class="o">=========================================================</span>
</pre></div>
</div>
<p>At the end of each optimization section the change in cost function, new values for the Jastrow parameters, and elapsed wall clock time are reported:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OldCost</span><span class="p">:</span> <span class="mf">7.0598901869e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">7.0592576381e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">6.3254886314e-05</span>
<span class="o">...</span>
 <span class="o">&lt;</span><span class="n">optVariables</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;O.q0.opt.s011.opt.xml&quot;</span><span class="o">&gt;</span>
<span class="n">uu_0</span> <span class="mf">6.9392504232e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">0</span>
<span class="n">uu_1</span> <span class="mf">4.9690781460e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">1</span>
<span class="n">uu_2</span> <span class="mf">4.0934542375e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">2</span>
<span class="n">uu_3</span> <span class="mf">3.7875640157e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">3</span>
<span class="n">uu_4</span> <span class="mf">3.7308380014e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">4</span>
<span class="n">uu_5</span> <span class="mf">3.5419786809e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">5</span>
<span class="n">uu_6</span> <span class="mf">4.3139019377e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">6</span>
<span class="n">uu_7</span> <span class="mf">1.9344371667e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">7</span>
<span class="n">ud_0</span> <span class="mf">3.9219009713e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">8</span>
<span class="n">ud_1</span> <span class="mf">1.2352664647e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">9</span>
<span class="n">ud_2</span> <span class="mf">4.4048945133e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">10</span>
<span class="n">ud_3</span> <span class="mf">2.1415676741e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">11</span>
<span class="n">ud_4</span> <span class="mf">1.5201803731e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">12</span>
<span class="n">ud_5</span> <span class="mf">2.3708169445e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">13</span>
<span class="n">ud_6</span> <span class="mf">3.4279064930e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">14</span>
<span class="n">ud_7</span> <span class="mf">4.3334583596e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">15</span>
<span class="n">eO_0</span> <span class="o">-</span><span class="mf">7.8490123937e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">16</span>
<span class="n">eO_1</span> <span class="o">-</span><span class="mf">6.6726618338e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">17</span>
<span class="n">eO_2</span> <span class="o">-</span><span class="mf">4.8753453838e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">18</span>
<span class="n">eO_3</span> <span class="o">-</span><span class="mf">3.0913993774e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">19</span>
<span class="n">eO_4</span> <span class="o">-</span><span class="mf">1.7901872177e-01</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">20</span>
<span class="n">eO_5</span> <span class="o">-</span><span class="mf">8.6199000697e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">21</span>
<span class="n">eO_6</span> <span class="o">-</span><span class="mf">4.0601160841e-02</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">22</span>
<span class="n">eO_7</span> <span class="o">-</span><span class="mf">4.1358075061e-03</span> <span class="mi">1</span> <span class="mi">1</span>  <span class="n">ON</span> <span class="mi">23</span>
 <span class="o">&lt;/</span><span class="n">optVariables</span><span class="o">&gt;</span>
<span class="o">...</span>
 <span class="n">QMC</span> <span class="n">Execution</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">2.8218972974e+01</span> <span class="n">secs</span>
</pre></div>
</div>
<p>The cost function should decrease during each linear optimization (<code class="docutils literal notranslate"><span class="pre">Delta</span> <span class="pre">cost</span> <span class="pre">&lt;</span> <span class="pre">0</span></code>).  Try “<code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">OldCost</span> <span class="pre">*opt.out.</span></code>”  You should see something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OldCost</span><span class="p">:</span> <span class="mf">1.2655186572e+00</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">7.2443875597e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">5.4107990118e-01</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">7.2229830632e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">6.9833678217e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">2.3961524143e-02</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">8.0649629434e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">8.0551871147e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">9.7758287036e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">6.6821241388e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">6.6797703487e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">2.3537901148e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">7.0106275099e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">7.0078055426e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">2.8219672877e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">6.9538522411e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">6.9419186712e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">1.1933569922e-03</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">6.7709626744e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">6.7501251165e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">2.0837557922e-03</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">6.6659923822e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">6.6651737755e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">8.1860671682e-05</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">7.7828995609e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">7.7735482525e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">9.3513083900e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">7.2717974404e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">7.2715201115e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">2.7732880747e-05</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">6.9400639873e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">6.9257183689e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">1.4345618444e-03</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">7.0598901869e-01</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">7.0592576381e-01</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">6.3254886314e-05</span>
</pre></div>
</div>
<p>Blocked averages of energy data, including the kinetic energy and components of the potential energy, are written to <code class="docutils literal notranslate"><span class="pre">scalar.dat</span></code> files.  The first is named “<code class="docutils literal notranslate"><span class="pre">O.q0.opt.s000.scalar.dat</span></code>,” with a series number of zero (<code class="docutils literal notranslate"><span class="pre">s000</span></code>).  In the end there will be <code class="docutils literal notranslate"><span class="pre">MAX</span></code> of them, one for each series.</p>
<p>When the job has finished, use the <code class="docutils literal notranslate"><span class="pre">qmca</span></code> tool to assess the effectiveness of the optimization process.  To look at just the total energy and the variance, type “<code class="docutils literal notranslate"><span class="pre">qmca</span> <span class="pre">-q</span> <span class="pre">ev</span> <span class="pre">O.q0.opt*scalar*</span></code>.”  This will print the energy, variance, and the variance/energy ratio in Hartree units:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">LocalEnergy</span>               <span class="n">Variance</span>           <span class="n">ratio</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">0</span>  <span class="o">-</span><span class="mf">15.739585</span> <span class="o">+/-</span> <span class="mf">0.007656</span>   <span class="mf">0.887412</span> <span class="o">+/-</span> <span class="mf">0.010728</span>   <span class="mf">0.0564</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">1</span>  <span class="o">-</span><span class="mf">15.848347</span> <span class="o">+/-</span> <span class="mf">0.004089</span>   <span class="mf">0.318490</span> <span class="o">+/-</span> <span class="mf">0.006404</span>   <span class="mf">0.0201</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">2</span>  <span class="o">-</span><span class="mf">15.867494</span> <span class="o">+/-</span> <span class="mf">0.004831</span>   <span class="mf">0.292309</span> <span class="o">+/-</span> <span class="mf">0.007786</span>   <span class="mf">0.0184</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">3</span>  <span class="o">-</span><span class="mf">15.871508</span> <span class="o">+/-</span> <span class="mf">0.003025</span>   <span class="mf">0.275364</span> <span class="o">+/-</span> <span class="mf">0.006045</span>   <span class="mf">0.0173</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">4</span>  <span class="o">-</span><span class="mf">15.865512</span> <span class="o">+/-</span> <span class="mf">0.002997</span>   <span class="mf">0.278056</span> <span class="o">+/-</span> <span class="mf">0.006523</span>   <span class="mf">0.0175</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">5</span>  <span class="o">-</span><span class="mf">15.864967</span> <span class="o">+/-</span> <span class="mf">0.002733</span>   <span class="mf">0.278065</span> <span class="o">+/-</span> <span class="mf">0.004413</span>   <span class="mf">0.0175</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">6</span>  <span class="o">-</span><span class="mf">15.869644</span> <span class="o">+/-</span> <span class="mf">0.002949</span>   <span class="mf">0.273497</span> <span class="o">+/-</span> <span class="mf">0.006141</span>   <span class="mf">0.0172</span>
<span class="n">O</span><span class="o">.</span><span class="n">q0</span><span class="o">.</span><span class="n">opt</span>  <span class="n">series</span> <span class="mi">7</span>  <span class="o">-</span><span class="mf">15.868397</span> <span class="o">+/-</span> <span class="mf">0.003838</span>   <span class="mf">0.285451</span> <span class="o">+/-</span> <span class="mf">0.007570</span>   <span class="mf">0.0180</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Plots of the data can also be obtained with the “<code class="docutils literal notranslate"><span class="pre">-p</span></code>” option
(“<code class="docutils literal notranslate"><span class="pre">qmca</span> <span class="pre">-p</span> <span class="pre">-q</span> <span class="pre">ev</span> <span class="pre">O.q0.opt*scalar*</span></code>”).</p>
<p>Identify which optimization series is the “best” according to your cost function.  It is likely that multiple series are similar in quality.  Note the <code class="docutils literal notranslate"><span class="pre">opt.xml</span></code> file corresponding to this series.  This file contains the final value of the optimized Jastrow parameters to be used in the DMC calculations of the next section of the lab.</p>
<p><strong>Questions and Exercises</strong></p>
<ol class="arabic simple">
<li><p>What is the acceptance ratio of your optimization runs? (use
“texttqmca -q ar O.q0.opt*scalar*”) Do you expect the MC sampling to
be efficient?</p></li>
<li><p>How do you know when the optimization process has converged?</p></li>
<li><p>(optional) Optimization is sometimes sensitive to initial guesses of
the parameters. If you have time, try varying the initial parameters,
including the cutoff radius (<code class="docutils literal notranslate"><span class="pre">rcut</span></code>) of the Jastrow factors
(remember to change <code class="docutils literal notranslate"><span class="pre">id</span></code> in the <code class="docutils literal notranslate"><span class="pre">&lt;project/&gt;</span></code> element). Do you
arrive at a similar set of final Jastrow parameters? What is the
lowest variance you are able to achieve?</p></li>
</ol>
</div>
<div class="section" id="dmc-timestep-extrapolation-i-neutral-oxygen-atom">
<h2>DMC timestep extrapolation I: neutral oxygen atom<a class="headerlink" href="#dmc-timestep-extrapolation-i-neutral-oxygen-atom" title="Permalink to this headline">¶</a></h2>
<p>The DMC algorithm contains two biases in addition to the fixed node and pseudopotential approximations that are important to control: time step and population control bias.  In this section we focus on estimating and removing time step bias from DMC calculations.  The essential fact to remember is that the bias vanishes as the time step goes to zero, while the needed computer time increases inversely with the time step.</p>
<p>In the same directory you used to perform wavefunction optimization (<code class="docutils literal notranslate"><span class="pre">oxygen_atom</span></code>) you will find a sample DMC input file for the neutral oxygen atom named <code class="docutils literal notranslate"><span class="pre">O.q0.dmc.in.xml</span></code>.  Open this file in a text editor and note the differences from the optimization case.  Wavefunction information is no longer included from <code class="docutils literal notranslate"><span class="pre">pw2qmcpack</span></code> but instead should come from the optimization run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!-- OPT_XML is from optimization, e.g. O.q0.opt.s008.opt.xml --&gt;
&lt;include href=&quot;OPT_XML&quot;/&gt;
</pre></div>
</div>
<p>Replace “<code class="docutils literal notranslate"><span class="pre">OPT_XML</span></code>” with the <code class="docutils literal notranslate"><span class="pre">opt.xml</span></code> file corresponding to the best Jastrow parameters you found in the last section (this is a file name similar to <code class="docutils literal notranslate"><span class="pre">O.q0.opt.s008.opt.xml</span></code>).</p>
<p>The QMC calculation section at the bottom is also different.  The linear optimization blocks have been replaced with XML describing a VMC run followed by DMC.  Descriptions of the input keywords follow.</p>
<dl class="simple">
<dt>timestep</dt><dd><p>Time step of the VMC/DMC random walk. In VMC choose a time step
corresponding to an acceptance ratio of about 50%. In DMC the
acceptance ratio is often above 99%.</p>
</dd>
<dt>warmupSteps</dt><dd><p>Number of MC steps discarded as a warmup or equilibration period of
the random walk.</p>
</dd>
<dt>steps</dt><dd><p>Number of MC steps per block. Physical quantities, such as the total
energy, are averaged over walkers and steps.</p>
</dd>
<dt>blocks</dt><dd><p>Number of blocks. This is also the number of average energy values
written to output files. The number should be greater than 200 for
meaningful statistical analysis of output data (e.g., via <code class="docutils literal notranslate"><span class="pre">qmca</span></code>).
The total number of MC steps each walker takes is
<code class="docutils literal notranslate"><span class="pre">blocks</span></code><span class="math notranslate nohighlight">\(\times\)</span><code class="docutils literal notranslate"><span class="pre">steps</span></code>.</p>
</dd>
<dt>samples</dt><dd><p>VMC only. This is the number of walkers used in subsequent DMC runs.
Each DMC walker is initialized with electron positions sampled from
the VMC random walk.</p>
</dd>
<dt>nonlocalmoves</dt><dd><p>DMC only. If yes/no, use the locality approximation/T-moves for
nonlocal pseudopotentials. T-moves generally improve the stability of
the algorithm and restore the variational principle for small systems
(T-moves version 1).</p>
</dd>
</dl>
<p>The purpose of the VMC run is to provide initial electron positions for each DMC walker.  Setting <span class="math notranslate nohighlight">\(\texttt{walkers}=1\)</span> in the VMC block ensures there will be only one VMC walker per execution thread.  There will be a total of 4 VMC walkers in this case (see <code class="docutils literal notranslate"><span class="pre">O.q0.dmc.qsub.in</span></code>).  We want the electron positions used to initialize the DMC walkers to be decorrelated from one another.  A VMC walker will often decorrelate from its current position after propagating for a few Ha <span class="math notranslate nohighlight">\(^{-1}\)</span> in imaginary time (in general, this is system dependent).  This leads to a rough rule of thumb for choosing <code class="docutils literal notranslate"><span class="pre">blocks</span></code> and <code class="docutils literal notranslate"><span class="pre">steps</span></code> for the VMC run (<span class="math notranslate nohighlight">\(\texttt{vwalkers}=4\)</span> here):</p>
<div class="math notranslate nohighlight" id="equation-eq68">
<span class="eqno">(68)<a class="headerlink" href="#equation-eq68" title="Permalink to this equation">¶</a></span>\[\begin{aligned}
   \texttt{VBLOCKS}\times\texttt{VSTEPS} \ge \frac{\texttt{DWALKERS}}{\texttt{VWALKERS}} \frac{5~\textrm{Ha}^{-1}}{\texttt{VTIMESTEP}}\end{aligned}\]</div>
<p>Fill in the VMC XML block with appropriate values for these parameters.
There should be more than one DMC walker per thread and enough walkers
in total to avoid population control bias. The general rule of thumb is
to have more than <span class="math notranslate nohighlight">\(\sim 2,000\)</span> walkers, although the dependence of
the total energy on population size should be explicitly checked from
time to time.</p>
<p>To study time step bias, we will perform a sequence of DMC runs over a
range of time steps (<span class="math notranslate nohighlight">\(0.1\)</span> Ha<span class="math notranslate nohighlight">\(^{-1}\)</span> is too large, and
time steps below <span class="math notranslate nohighlight">\(0.002\)</span> Ha<span class="math notranslate nohighlight">\(^{-1}\)</span> are probably too
small). A common approach is to select a fairly large time step to begin
with and then decrease the time step by a factor of two in each
subsequent DMC run. The total amount of imaginary time the walker
population propagates should be the same for each run. A simple way to
accomplish this is to choose input parameters in the following way</p>
<div class="math notranslate nohighlight" id="equation-eq69">
<span class="eqno">(69)<a class="headerlink" href="#equation-eq69" title="Permalink to this equation">¶</a></span>\[\begin{split} \begin{aligned}
   \texttt{timestep}_{n}    &amp;= \texttt{timestep}_{n-1}/2\nonumber\\
   \texttt{warmupSteps}_{n} &amp;= \texttt{warmupSteps}_{n-1}\times 2\nonumber\\
   \texttt{blocks}_{n}      &amp;= \texttt{blocks}_{n-1}\nonumber\\
   \texttt{steps}_{n}       &amp;= \texttt{steps}_{n-1}\times 2\end{aligned}\end{split}\]</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="lab_qmc_statistics.html" class="btn btn-neutral float-left" title="Lab 1: MC Statistical Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, QMCPACK Developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>