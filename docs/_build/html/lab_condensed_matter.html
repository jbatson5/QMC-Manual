

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab 4: Condensed Matter Calculations &mdash; QMCPACK Manual  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lab 5: Excited state calculations" href="lab_excited.html" />
    <link rel="prev" title="Lab 3: Advanced molecular calculations" href="lab_advanced_molecules.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> QMCPACK Manual
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Features of QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Obtaining, installing, and validating QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units used in QMCPACK</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_overview.html">Input file overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulationcell.html">Specifying the system to be simulated</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_wavefunction.html">Trial wavefunction specificaion</a></li>
<li class="toctree-l1"><a class="reference internal" href="hamiltonianobservable.html">Hamiltonian and Observables</a></li>
<li class="toctree-l1"><a class="reference internal" href="methods.html">Quantum Monte Carlo Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="output_overview.html">Output Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzing.html">Analyzing QMCPACK data</a></li>
<li class="toctree-l1"><a class="reference internal" href="LCAO.html">Periodic LCAO for Solids</a></li>
<li class="toctree-l1"><a class="reference internal" href="sCI.html">Selected Configuration Interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="afqmc.html">Auxiliary-Field Quantum Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab_qmc_statistics.html">Lab 1: MC Statistical Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab_qmc_basics.html">Lab 2: QMC Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab_advanced_molecules.html">Lab 3: Advanced molecular calculations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 4: Condensed Matter Calculations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#topics-covered-in-this-lab">Topics covered in this lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lab-directories-and-files">Lab directories and files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preliminaries">Preliminaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#total-energy-of-bcc-beryllium">Total energy of BCC beryllium</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handling-a-2d-system-graphene">Handling a 2D system: graphene</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lab_excited.html">Lab 5: Excited state calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="additional_tools.html">Additional Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="external_tools.html">External Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to the Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="unit_testing.html">Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="design_features.html">QMCPACK Design and Feature Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendices.html">Appendices</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">QMCPACK Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Lab 4: Condensed Matter Calculations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/lab_condensed_matter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-4-condensed-matter-calculations">
<span id="lab-condensed-matter"></span><h1>Lab 4: Condensed Matter Calculations<a class="headerlink" href="#lab-4-condensed-matter-calculations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="topics-covered-in-this-lab">
<h2>Topics covered in this lab<a class="headerlink" href="#topics-covered-in-this-lab" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Tiling DFT primitive cells into QMC supercells</p></li>
<li><p>Reducing finite-size errors via extrapolation</p></li>
<li><p>Reducing finite-size errors via averaging over twisted boundary
conditions</p></li>
<li><p>Using the B-spline mesh factor to reduce memory requirements</p></li>
<li><p>Using a coarsely resolved vacuum buffer region to reduce memory
requirements</p></li>
<li><p>Calculating the DMC total energies of representative 2D and 3D
extended systems</p></li>
</ul>
</div>
<div class="section" id="lab-directories-and-files">
<h2>Lab directories and files<a class="headerlink" href="#lab-directories-and-files" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>labs/lab4_condensed_matter/
├── Be-2at-setup.py           - DFT only for prim to conv cell
├── Be-2at-qmc.py             - QMC only for prim to conv cell
├── Be-16at-qmc.py            - DFT and QMC for prim to 16 atom cell
├── graphene-setup.py         - DFT and OPT for graphene
├── graphene-loop-mesh.py     - VMC scan over orbital bspline mesh factors
├── graphene-final.py         - DMC for final meshfactor
└── pseudopotentials          - pseudopotential directory
    ├── Be.ncpp                 - Be PP for Quantum ESPRESSO
    ├── Be.xml                  - Be PP for QMCPACK
    ├── C.BFD.upf               - C  PP for Quantum ESPRESSO
    └── C.BFD.xml               - C  PP for QMCPACK
</pre></div>
</div>
<p>The goal of this lab is to introduce you to the somewhat specialized problems involved in performing DMC calculations on condensed matter as opposed to the atoms and molecules that were the focus of the preceding labs.   Calculations will be performed on two different systems.  Firstly, we will perform a series of calculations on BCC beryllium, focusing on the necessary methodology to limit finite-size effects.  Secondly, we will perform calculations on graphene as an example of a system where QMCPACK’s capability to handle cases with mixed periodic and open boundary conditions is useful.  This example will also focus on strategies to limit memory usage for such systems.
All of the calculations performed in this lab will use the Nexus workflow management system, which vastly simplifies the process by automating the steps of generating trial wavefunctions and performing DMC calculations.</p>
</div>
<div class="section" id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">¶</a></h2>
<p>For any DMC calculation, we must start with a trial wavefunction. As is typical for our calculations of condensed matter, we will produce this wavefunction using DFT.  Specifically, we will use QE to generate a Slater determinant of SPOs.  This is done as a three-step process.  First, we calculate the converged charge density by performing a DFT calculation with a fine grid of k-points to fully sample the Brillouin zone.  Next, a non-self- consistent calculation is performed at the specific k-points needed for the supercell and twists needed in the DMC calculation (more on this later).  Finally, a wavefunction is converted from the binary representation used by QE to the portable hdf5 representation used by QMCPACK.</p>
<p>The choice of k-points necessary to generate the wavefunctions depends on both the supercell chosen for the DMC calculation and by the supercell twist vectors needed.  Recall that the wavefunction in a plane-wave DFT calculation is written using Bloch’s theorem as:</p>
<div class="math notranslate nohighlight" id="equation-eq70">
<span class="eqno">(70)<a class="headerlink" href="#equation-eq70" title="Permalink to this equation">¶</a></span>\[\Psi(\vec{r}) = e^{i\vec{k}\cdot\vec{r}}u(\vec{r})\:,\]</div>
<p>where <span class="math notranslate nohighlight">\(\vec{k}\)</span> is confined to the first Brillouin zone of the
cell chosen and <span class="math notranslate nohighlight">\(u(\vec{r})\)</span> is periodic in this simulation cell.
A plane-wave DFT calculation stores the periodic part of the
wavefunction as a linear combination of plane waves for each SPO at all
k-points selected. The symmetry of the system allows us to generate an
arbitrary supercell of the primitive cell as follows: Consider the set
of primitive lattice vectors, <span class="math notranslate nohighlight">\(\{ \mathbf{a}^p_1, \mathbf{a}^p_2,
\mathbf{a}^p_3\}\)</span>. We may write these vectors in a matrix,
<span class="math notranslate nohighlight">\(\mathbf{L}_p\)</span>, the rows of which are the primitive lattice
vectors. Consider a nonsingular matrix of integers, <span class="math notranslate nohighlight">\(\mathbf{S}\)</span>.
A corresponding set of supercell lattice vectors,
<span class="math notranslate nohighlight">\(\{\mathbf{a}^s_1, \mathbf{a}^s_2, \mathbf{a}^s_3\}\)</span>, can be
constructed by the matrix product</p>
<div class="math notranslate nohighlight" id="equation-eq71">
<span class="eqno">(71)<a class="headerlink" href="#equation-eq71" title="Permalink to this equation">¶</a></span>\[\mathbf{a}^s_i = S_{ij} \mathbf{a}^p_j]\:.\]</div>
<p>If the primitive cell contains <span class="math notranslate nohighlight">\(N_p\)</span> atoms, the supercell will
then contain <span class="math notranslate nohighlight">\(N_s = |\det(\mathbf{S})| N_p\)</span> atoms.</p>
<p>Now, the wavefunciton at any point in this new supercell can be related
to the wavefunction in the primitive cell by finding the linear
combination of primitive lattice vectors that maps this point back to
the primitive cell:</p>
<div class="math notranslate nohighlight" id="equation-eq72">
<span class="eqno">(72)<a class="headerlink" href="#equation-eq72" title="Permalink to this equation">¶</a></span>\[\vec{r}' = \vec{r} + x \mathbf{a}^p_1 + y \mathbf{a}^p_2 + z\mathbf{a}^p_3 = \vec{r} + \vec{T}\:,\]</div>
<p>where <span class="math notranslate nohighlight">\(x, y, z\)</span> are integers. Now the wavefunction in the
supercell at point <span class="math notranslate nohighlight">\(\vec{r}'\)</span> can be written in terms of the
wavefunction in the primitive cell at <span class="math notranslate nohighlight">\(\vec{r}'\)</span> as:</p>
<div class="math notranslate nohighlight" id="equation-eq73">
<span class="eqno">(73)<a class="headerlink" href="#equation-eq73" title="Permalink to this equation">¶</a></span>\[\Psi(\vec{r}) = \Psi(\vec{r}') e^{i \vec{T} \cdot \vec{k}}\:,\]</div>
<p>where <span class="math notranslate nohighlight">\(\vec{k}\)</span> is confined to the first Brillouin zone of the
primitive cell. We have also chosen the supercell twist vector, which
places a constraint on the form of the wavefunction in the supercell.
The combination of these two constraints allows us to identify family of
N k-points in the primitive cell that satisfy the constraints. Thus, for
a given supercell tiling matrix and twist angle, we can write the
wavefunction everywhere in the supercell by knowing the wavefunction a N
k-points in the primitive cell. This means that the memory necessary to
store the wavefunction in a supercell is only linear in the size of the
supercell rather than the quadratic cost if symmetry were neglected.</p>
</div>
<div class="section" id="total-energy-of-bcc-beryllium">
<h2>Total energy of BCC beryllium<a class="headerlink" href="#total-energy-of-bcc-beryllium" title="Permalink to this headline">¶</a></h2>
<p>When performing calculations of periodic solids with QMC, it is essential to work with a reasonable size supercell rather than the primitive cells that are common in mean field calculations.  Specifically, all of the finite-size correction schemes discussed in the morning require that the exchange-correlation hole be considerably smaller than the periodic simulation cell.  Additionally, finite-size effects are lessened as the distance between the electrons in the cell and their periodic images increases, so it is advantageous to generate supercells that are as spherical as possible to maximize this distance.  However, a competing consideration is that when calculating total energies we often want to extrapolate the energy per particle to the thermodynamic limit by means of the following formula in three dimensions:</p>
<div class="math notranslate nohighlight" id="equation-eq74">
<span class="eqno">(74)<a class="headerlink" href="#equation-eq74" title="Permalink to this equation">¶</a></span>\[ E_{\inf} = C + E_{N}/N\:.\]</div>
<p>This formula derived assuming the shape of the supercells is consistent
(more specifically that the periodic distances scale uniformly with
system size), meaning we will need to do a uniform tiling, that is,
<span class="math notranslate nohighlight">\(2\times2\times2\)</span>, <span class="math notranslate nohighlight">\(3\times3\times3\)</span>, etc. As a
<span class="math notranslate nohighlight">\(3\times3\times3\)</span> tiling is 27 times larger than the supercell and
the practical limit of DMC is on the order of 200 atoms (depending on
Z), sometimes it is advantageous to choose a less spherical supercell
with fewer atoms rather than a more spherical one that is too expensive
to tile.</p>
<p>In the case of a BCC crystal, it is possible to tile the one atom
primitive cell to a cubic supercell only by doubling the number of
electrons. This is the best possible combination of a small number of
atoms that can be tiled and a regular box that maximizes the distance
between periodic images. We will need to determine the tiling matrix S
that generates this cubic supercell by solving the following equation
for the coefficients of the S matrix:</p>
<div class="math notranslate nohighlight" id="equation-eq75">
<span class="eqno">(75)<a class="headerlink" href="#equation-eq75" title="Permalink to this equation">¶</a></span>\[\begin{split}\left[\begin{array}{rrr}
  1 &amp; 0 &amp; 0 \\
  0 &amp; 1 &amp; 0 \\
  0 &amp; 0 &amp; 1
  \end{array}\right] =  \left[\begin{array}{rrr}
  s_{11} &amp; s_{12} &amp; s_{13} \\
  s_{21} &amp; s_{22} &amp; s_{23} \\
  s_{31} &amp; s_{32} &amp; s_{33}
  \end{array}\right] \cdot
\left[\begin{array}{rrr}
  0.5 &amp;  0.5 &amp; -0.5 \\
 -0.5 &amp;  0.5 &amp;  0.5 \\
  0.5 &amp; -0.5 &amp;  0.5
\end{array}\right]\:.\end{split}\]</div>
<p>We will now use Nexus to generate the trial wavefunction for this BCC beryllium.</p>
<p>Fortunately, the Nexus will handle determination of the proper k-vectors given the tiling matrix.  All that is needed is to place the tiling matrix in the <code class="docutils literal notranslate"><span class="pre">Be-2at-setup.py</span></code> file.   Now the definition of the physical system is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bcc_Be</span> <span class="o">=</span> <span class="n">generate_physical_system</span><span class="p">(</span>
    <span class="n">lattice</span>    <span class="o">=</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span>
    <span class="n">cell</span>       <span class="o">=</span> <span class="s1">&#39;primitive&#39;</span><span class="p">,</span>
    <span class="n">centering</span>  <span class="o">=</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
    <span class="n">atoms</span>      <span class="o">=</span> <span class="s1">&#39;Be&#39;</span><span class="p">,</span>
    <span class="n">constants</span>  <span class="o">=</span> <span class="mf">3.490</span><span class="p">,</span>
    <span class="n">units</span>      <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
    <span class="n">net_charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">net_spin</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Be</span>         <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">tiling</span>     <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">],[</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">f</span><span class="p">],[</span><span class="n">g</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">i</span><span class="p">]],</span>
    <span class="n">kgrid</span>      <span class="o">=</span> <span class="n">kgrid</span><span class="p">,</span>
    <span class="n">kshift</span>     <span class="o">=</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>where the tiling line should be replaced with the preceding row major
tiling matrix. This script file will now perform a converged DFT
calculation to generate the charge density in a directory called
<code class="docutils literal notranslate"><span class="pre">bcc-beryllium/scf</span></code> and perform a non-self-consistend DFT calculation
to generate SPOs in the directory <code class="docutils literal notranslate"><span class="pre">bcc-beryllium/nscf</span></code>. Fortunately,
Nexus will calculate the required k-points needed to tile the
wavefunction to the supercell, so all that is necessary is the
granularity of the supercell twists and whether this grid is shifted
from the origin. Once this is finished, it performs the conversion from
pwscf’s binary format to the hdf5 format used by QMCPACK. Finally, it
will optimize the coefficients of 1-body and 2-body Jastrow factors in
the supercell defined by the tiling matrix.</p>
<p>Run these calculations by executing the script <code class="docutils literal notranslate"><span class="pre">Be-2at-setup.py</span></code>. You
will notice the small calculations required to generate the wavefunction
of beryllium in a one-atom cell are rather inefficient to run on a
high-performance computer such as vesta in terms of the time spent doing
calculations versus time waiting on the scheduler and booting compute
nodes. One of the benefits of the portable HDF format that is used by
QMCPACK is that you can generate data like wavefunctions on a local
workstation or other convenient resource and use high-performance
clusters for the more expensive QMC calculations.</p>
<p>In this case, the wavefunction is generated in the directory
<code class="docutils literal notranslate"><span class="pre">bcc-beryllium/nscf-2at_222/pwscf_</span> <span class="pre">output</span></code> in a file called
<code class="docutils literal notranslate"><span class="pre">pwscf.pwscf.h5</span></code>. For debugging purposes, it can be useful to verify
that the contents of this file are what you expect. For instance, you
can use the tool <code class="docutils literal notranslate"><span class="pre">h5ls</span></code> to check the geometry of the cell where the
DFT calculations were performed or the number of k-points or electrons
in the calculation. This is done with the command h5ls -d
pwscf.pwscf.h5/supercell or h5ls -d pwscf.pwscf.h5/electrons.</p>
<p>In the course of running <code class="docutils literal notranslate"><span class="pre">Be-2at-setup.py</span></code>, you will get an error when
attempting to perform the VMC and wavefunction optimization
calculations. This is because the wavefunction has generated supercell
twists of the form (+/- 1/4, +/- 1/4, +/- 1/4). In the case that the
supercell twist contains only 0 or 1/2, it is possible to operate
entirely with real arithmetic. The executable that has been indicated in
<code class="docutils literal notranslate"><span class="pre">Be-2at-setup.py</span></code> was compiled for this case. Note that where
possible, the memory use is a factor of two less than the general case
and the calculations are somewhat faster. However, it is often necessary
to perform calculations away from these special twist angles to reduce
finite-size effects. To fix this, delete the directory
<code class="docutils literal notranslate"><span class="pre">bcc-beryllium/opt-2at</span></code>, change the line near the top of
<code class="docutils literal notranslate"><span class="pre">Be-2at-setup.py</span></code> from</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qmcpack</span>    <span class="o">=</span> <span class="s1">&#39;/soft/applications/qmcpack/Binaries/qmcpack&#39;</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qmcpack</span>    <span class="o">=</span> <span class="s1">&#39;/soft/applications/qmcpack/Binaries/qmcpack_comp&#39;</span>
</pre></div>
</div>
<p>and rerun the script.</p>
<p>When the optimization calculation has finished, check that everything has proceeded correctly by looking at the output in the <code class="docutils literal notranslate"><span class="pre">opt-2at</span></code> directory.  Firstly, you can grep the output file for Delta to see if the cost function has indeed been decreasing during the optimization.  You should find something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OldCost</span><span class="p">:</span> <span class="mf">4.8789147e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">4.0695360e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">8.0937871e-03</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">3.8507795e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">3.8338486e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">1.6930674e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">4.1079105e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">4.0898345e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">1.8076319e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">4.2681333e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">4.2356598e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">3.2473514e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">3.9168577e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">3.8552883e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">6.1569350e-04</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">4.2176276e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">4.2083371e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">9.2903058e-05</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">4.3977361e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">4.2865751e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">1.11161830</span><span class="o">-</span><span class="mi">03</span>
<span class="n">OldCost</span><span class="p">:</span> <span class="mf">4.1420944e-02</span> <span class="n">NewCost</span><span class="p">:</span> <span class="mf">4.0779569e-02</span> <span class="n">Delta</span> <span class="n">Cost</span><span class="p">:</span><span class="o">-</span><span class="mf">6.4137501e-04</span>
</pre></div>
</div>
<p>which shows that the starting wavefunction was fairly good and that most
of the optimization occurred in the first step. Confirm this by using
<code class="docutils literal notranslate"><span class="pre">qmca</span></code> to look at how the energy and variance changed over the course
of the calculation with the command: <code class="docutils literal notranslate"><span class="pre">qmca</span> <span class="pre">-q</span> <span class="pre">ev</span> <span class="pre">-e</span> <span class="pre">10</span> <span class="pre">*.scalar.dat</span></code>
executed in the <code class="docutils literal notranslate"><span class="pre">opt-2at</span> <span class="pre">directory</span></code>. You should get output like the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">LocalEnergy</span>               <span class="n">Variance</span>             <span class="n">ratio</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">0</span>  <span class="o">-</span><span class="mf">2.159139</span> <span class="o">+/-</span> <span class="mf">0.001897</span>   <span class="mf">0.047343</span> <span class="o">+/-</span> <span class="mf">0.000758</span>   <span class="mf">0.0219</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">1</span>  <span class="o">-</span><span class="mf">2.163752</span> <span class="o">+/-</span> <span class="mf">0.001305</span>   <span class="mf">0.039389</span> <span class="o">+/-</span> <span class="mf">0.000666</span>   <span class="mf">0.0182</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">2</span>  <span class="o">-</span><span class="mf">2.160913</span> <span class="o">+/-</span> <span class="mf">0.001347</span>   <span class="mf">0.040879</span> <span class="o">+/-</span> <span class="mf">0.000682</span>   <span class="mf">0.0189</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">3</span>  <span class="o">-</span><span class="mf">2.162043</span> <span class="o">+/-</span> <span class="mf">0.001223</span>   <span class="mf">0.041183</span> <span class="o">+/-</span> <span class="mf">0.001250</span>   <span class="mf">0.0190</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">4</span>  <span class="o">-</span><span class="mf">2.162441</span> <span class="o">+/-</span> <span class="mf">0.000865</span>   <span class="mf">0.039597</span> <span class="o">+/-</span> <span class="mf">0.000342</span>   <span class="mf">0.0183</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">5</span>  <span class="o">-</span><span class="mf">2.161287</span> <span class="o">+/-</span> <span class="mf">0.000732</span>   <span class="mf">0.039954</span> <span class="o">+/-</span> <span class="mf">0.000498</span>   <span class="mf">0.0185</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">6</span>  <span class="o">-</span><span class="mf">2.163458</span> <span class="o">+/-</span> <span class="mf">0.000973</span>   <span class="mf">0.044431</span> <span class="o">+/-</span> <span class="mf">0.003583</span>   <span class="mf">0.0205</span>
<span class="n">opt</span>  <span class="n">series</span> <span class="mi">7</span>  <span class="o">-</span><span class="mf">2.163495</span> <span class="o">+/-</span> <span class="mf">0.001027</span>   <span class="mf">0.040783</span> <span class="o">+/-</span> <span class="mf">0.000413</span>   <span class="mf">0.0189</span>
</pre></div>
</div>
<p>Now that the optimization has completed successfully, we can perform DMC
calculations. The first goal of the calculations will be to try to
eliminate the 1-body finite-size effects by twist averaging. The script
<code class="docutils literal notranslate"><span class="pre">Be-2at-qmc.py</span></code> has the necessary input. Note that on line 42 two
twist grids are specified, (2,2,2) and (3,3,3). Change the tiling matrix
in this input file as in <code class="docutils literal notranslate"><span class="pre">Be-2at-qmc.py</span></code> and start the calculations.
Note that this workflow takes advantage of QMCPACK’s capability to group
jobs. If you look in the directory <code class="docutils literal notranslate"><span class="pre">dmc-2at_222</span></code> at the job submission
script (<code class="docutils literal notranslate"><span class="pre">dmc.qsub.in</span></code>), you will note that rather than operating on an
XML input file, <code class="docutils literal notranslate"><span class="pre">qmcapp</span></code> is targeting a text file called <code class="docutils literal notranslate"><span class="pre">dmc.in</span></code>.
This file is a simple text file that contains the names of the eight XML
input files needed for this job, one for each twist. When operated in
this mode, QMCPACK will use MPI groups to run multiple copies of itself
within the same MPI context. This is often useful both in terms of
organizing calculations and for taking advantage of the large job sizes
that computer centers often encourage.</p>
<p>The DMC calculations in this case are designed to complete in a few
minutes. When they have finished running, first look at the
<code class="docutils literal notranslate"><span class="pre">scalar.dat</span></code> files corresponding to the DMC calculations at the
various twists in <code class="docutils literal notranslate"><span class="pre">dmc-2at_222</span></code>. Using a command such as
<code class="docutils literal notranslate"><span class="pre">qmca</span> <span class="pre">-q</span> <span class="pre">ev</span> <span class="pre">-e</span> <span class="pre">32</span> <span class="pre">*.s001.scalar.dat</span></code> (with a suitably chosen number of
blocks for the equilibration), you will see that the DMC energy in each
calculation is nearly identical within the statistical uncertainty of
the calculations. In the case of a large supercell, this is often
indicative of a situation where the Brillouin zone is so small that the
1-body finite-size effects are nearly converged without any twist
averaging. In this case, however, this is because of the symmetry of the
system. For this cubic supercell, all of the twist angles chosen in this
shifted <span class="math notranslate nohighlight">\(2\times2\times2\)</span> grid are equivalent by symmetry. In the
case where substantial resources are required to equilibrate the DMC
calculations, it can be beneficial to avoid repeating such twists and
instead simply weight them properly. In this case, however, where the
equilibration is inexpensive, there is no benefit to adding such
complexity as the calculations can simply be averaged together and the
result is equivalent to performing a single longer calculation.</p>
<p>Using the command <code class="docutils literal notranslate"><span class="pre">qmc</span> <span class="pre">-a</span> <span class="pre">-q</span> <span class="pre">ev</span> <span class="pre">-e</span> <span class="pre">16</span> <span class="pre">*.s001.scalar.dat</span></code>, average the
DMC energies in <code class="docutils literal notranslate"><span class="pre">dmc-2at_222</span> <span class="pre">and</span> <span class="pre">dmc-2at_333</span></code> to see whether the
1-body finite-size effects are converged with a <span class="math notranslate nohighlight">\(3\times3\times3\)</span>
grid of twists. When using beryllium as a metal, the convergence is
quite poor (0.025 Ha/Be or 0.7 eV/Be). If this were a production
calculation it would be necessary to perform calculations on much larger
grids of supercell twists to eliminate the 1-body finite-size effects.</p>
<p>In this case there are several other calculations that would warrant a
high priority. Script <code class="docutils literal notranslate"><span class="pre">Be-16at-qmc.py</span></code> has been provided in which you
can input the appropriate tiling matrix for a 16-atom cell and perform
calculations to estimate the 2-body finite-size effects, which will also
be quite large in the 2-atom calculations. This script will take
approximately 30 minutes to run to completion, so depending on your
interest, you can either run it or work to modify the scripts to address
the other technical issues that would be necessary for a production
calculation such as calculating the population bias or the time step
error in the DMC calculations.</p>
<p>Another useful exercise would be to attempt to validate this PP by
calculating the ionization potential and electron affinity of the
isolated atom and compare it with the experimental values: IP = 9.3227
eV , EA = 2.4 eV.</p>
</div>
<div class="section" id="handling-a-2d-system-graphene">
<h2>Handling a 2D system: graphene<a class="headerlink" href="#handling-a-2d-system-graphene" title="Permalink to this headline">¶</a></h2>
<p>In this section we examine a calculation of an isolated sheet of
graphene. Because graphene is a 2D system, we will take advantage of
QMCPACK’s capability to mix periodic and open boundary conditions to
eliminate and spurious interaction of the sheet with its images in the z
direction. Run the script <code class="docutils literal notranslate"><span class="pre">graphene-setup.py</span></code>, which will generate the
wavefunction and optimize one and two body jastrow factors. In the
script; notice line 160: bconds = ’ppn’ in the generate_qmcpack
function, which specifies this mix of open and periodic boundary
conditions. Consequently, the atoms will need to be kept away from this
open boundary in the z direction as the electronic wavefunction will not
be defined outside of the simulation box in this direction. For this
reason, all of the atom positions at the beginning of the file have z
coordinates 7.5. At this point, run the script <code class="docutils literal notranslate"><span class="pre">graphene-setup.py</span></code>.</p>
<p>Aside from the change in boundary conditions, the main thing that
distinguishes this kind of calculation from the previous beryllium
example is the large amount of vacuum in the cell. Although this is a
very small calculation designed to run quickly in the tutorial, in
general a more converged calculation would quickly become memory limited
on an architecture like BG/Q. When the initial wavefunction optimization
has completed to your satisfaction, run the script
<code class="docutils literal notranslate"><span class="pre">graphene-loop-mesh.py</span></code>. This examines within VMC an approach to
reducing the memory required to store the wavefunction. In
<code class="docutils literal notranslate"><span class="pre">graphene-loop-mesh.py</span></code>, the spacing between the B-spline points is
varied uniformly. The mesh spacing is a prefactor to the linear spacing
between the spline points, so the memory use goes as the cube of the
meshfactor. When you run the calculations, examine the
<code class="docutils literal notranslate"><span class="pre">.s000.scalar.dat</span></code> files with <code class="docutils literal notranslate"><span class="pre">qmca</span></code> to determine the lowest
possible mesh spacing that preserves both the VMC energy and the
variance.</p>
<p>Finally, edit the file <code class="docutils literal notranslate"><span class="pre">graphene-final.py</span></code>, which will perform two DMC
calculations. In the first, (qmc1) replace the following lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">meshfactor</span>   <span class="o">=</span> <span class="n">xxx</span><span class="p">,</span>
<span class="n">precision</span>    <span class="o">=</span> <span class="s1">&#39;---&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>with the values you have determined will perform the calculation with as small as possible wavefunction.  Note that we can also use single precision arithmetic to store the wavefunction by specifying precision=`single.’  When you run the script, compare the output of the two DMC calculations in terms of energy and variance.  Also, see if you can calculate the fraction of memory that you were able to save by using a meshfactor other than 1 and single precision arithmetic.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>Upon completion of this lab, you should be able to use Nexus to perform DMC calculations on periodic solids when provided with a PP.  You should also be able to reduce the size of the wavefunction in a solid-state calculation in cases where memory is a limiting factor.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lab_excited.html" class="btn btn-neutral float-right" title="Lab 5: Excited state calculations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lab_advanced_molecules.html" class="btn btn-neutral float-left" title="Lab 3: Advanced molecular calculations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, QMCPACK Developers

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>